<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>webrtc-example</title>
</head>

<body>
<script>
    let pc = new RTCPeerConnection({
        iceServers: [
            {
                urls: 'stun:stun.l.google.com:19302'
            }
        ]
    });
    let log = msg => {
        document.getElementById('div').innerHTML += msg + '<br>'
    };

    pc.ontrack = function (event) {
        var el = document.createElement(event.track.kind);
        el.srcObject = event.streams[0];
        el.autoplay = true;
        el.controls = true;

        document.getElementById('remoteVideos').appendChild(el)
    };

    let dataChannel = pc.createDataChannel('foo');
    dataChannel.onclose = () => console.log('dataChannel has closed');
    dataChannel.onopen = () => console.log('dataChannel has opened');
    dataChannel.onmessage = e => log(`Message from DataChannel '${dataChannel.label}' payload '${e.data}'`);

    const session_id = "abc";

    pc.oniceconnectionstatechange = e => log(pc.iceConnectionState);
    pc.onicecandidate = event => {
        if (event.candidate === null) {
            fetch(`https://webrtc-sdp-exchanger.appspot.com/sessions/${session_id}` , {
                method: "POST",
                mode: "cors",
                headers: new Headers({ "Content-Type": "application/json; charset=utf-8" }),
                body: JSON.stringify({session_description: pc.localDescription, session_id:session_id}),
            }).then((response)=>console.log).catch(err=>console.error);
        }
    };

    // Offer to receive 1 audio, and 2 video tracks
    pc.addTransceiver('audio', {'direction': 'recvonly'});
    pc.addTransceiver('video', {'direction': 'recvonly'});
    pc.addTransceiver('video', {'direction': 'recvonly'});
    pc.createOffer().then(d => pc.setLocalDescription(d)).catch(log);

    window.startSession = () => {
        fetch(`https://webrtc-sdp-exchanger.appspot.com/sessions/${session_id}/answer` , {
            method: "GET",
            mode: "cors",
            headers: new Headers({ "Content-Type": "application/json; charset=utf-8" }),
        }).then((response) => {
            if (response.ok) {
                return response.json();
            }
            return Promise.reject(new Error("invalid response"));
        }).then((json) => {
            console.log("catch session desc");
            try {
                pc.setRemoteDescription(new RTCSessionDescription(json.session_description));
            } catch (e) {
                alert(e);
            }
        }).catch(err=>console.error);
    };

    window.sendCommand = () => {
        let message = document.getElementById('command').value;
        if (message === '') {
            return;
        }

        dataChannel.send(message);
        document.getElementById('command').value = "";
    };
</script>
<div>
<textarea id="sessionId">test</textarea> <br/>
<button onclick="window.startSession()"> Start Session</button>
</div>

<div>
Command: <textarea id="command"></textarea> <br/>
<button id="sendCommand" onclick="window.sendCommand()"> Send Command</button>
</div>

<br/>

<div>Video<br/>
<div id="remoteVideos"></div>
</div>

<div>
Logs<br/>
<div id="div"></div>
</div>

<script>
    document.getElementById('command').addEventListener('keypress', (event) => {
        console.log(event);
        if (event.key === 'Enter') {
            document.getElementById('sendCommand').click();
            return false
        }
    });
</script>
</body>
</html>
