<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>webrtc-example</title>
</head>

<body>
<script>
    window.startSession = () => {
        document.getElementById('startSession').disabled = "true";

        let pc = new RTCPeerConnection({
            iceServers: [
                {
                    urls: 'stun:stun.l.google.com:19302'
                }
            ]
        });
        let log = msg => {
            document.getElementById('div').innerHTML += msg + '<br>'
        };

        pc.ontrack = (event) => {
            var el = document.createElement(event.track.kind);
            el.srcObject = event.streams[0];
            el.autoplay = true;
            el.controls = true;

            document.getElementById('remoteVideos').appendChild(el)
        };

        let dataChannel = pc.createDataChannel('foo');
        dataChannel.onclose = () => console.log('dataChannel has closed');
        dataChannel.onopen = () => {
            console.log('dataChannel has opened');
            document.getElementById('sendCommand').disabled = "";
        };
        dataChannel.onmessage = e => log(`Message from DataChannel '${dataChannel.label}' payload '${e.data}'`);

        window.onbeforeunload = () => {
            dataChannel.close();
            pc.close();
        };

        let params = new URLSearchParams(document.location.search.substring(1));
        let session_id = params.get("session");

        pc.oniceconnectionstatechange = (e) => {
            log('ice connection state: ' + pc.iceConnectionState);
            if (pc.iceConnectionState === 'checking') {
                fetch(`https://webrtc-sdp-exchanger.appspot.com/sessions/${session_id}/answer`, {
                    method: "GET",
                    mode: "cors",
                    headers: new Headers({"Content-Type": "application/json; charset=utf-8"}),
                }).then((response) => {
                    if (response.ok) {
                        return response.json();
                    }
                    return Promise.reject(new Error("invalid response"));
                }).then((json) => {
                    console.log("catch session desc");
                    try {
                        pc.setRemoteDescription(new RTCSessionDescription(json.session_description));
                    } catch (e) {
                        alert(e);
                    }
                }).catch(err => console.error);
            }
        };

        pc.onconnectionstatechange = (e) => {
            log('connection state: ' + pc.connectionState);
        };

        pc.onicecandidate = event => {
            if (event.candidate === null) {
                fetch(`https://webrtc-sdp-exchanger.appspot.com/sessions/${session_id}`, {
                    method: "POST",
                    mode: "cors",
                    headers: new Headers({"Content-Type": "application/json; charset=utf-8"}),
                    body: JSON.stringify({session_description: pc.localDescription, session_id: session_id}),
                }).then((response) => console.log).catch(err => console.error);
            }
        };

        // Offer to receive 1 audio, and 2 video tracks
        pc.addTransceiver('audio', {'direction': 'recvonly'});
        pc.addTransceiver('video', {'direction': 'recvonly'});
        pc.addTransceiver('video', {'direction': 'recvonly'});
        pc.createOffer().then(d => pc.setLocalDescription(d)).catch(log);


        window.sendCommand = () => {
            let message = document.getElementById('command').value;
            if (message === '') {
                return;
            }

            dataChannel.send(message + '\n');
            document.getElementById('command').value = "";
        };
    }
</script>
<div>
<button id="startSession" onclick="window.startSession()"> Start Session</button>
</div>

<div>
Command: <textarea id="command"></textarea> <br/>
<button id="sendCommand" disabled="true" onclick="window.sendCommand()"> Send Command</button>
</div>

<br/>

<div>Video<br/>
<div id="remoteVideos"></div>
</div>

<div>
Logs<br/>
<div id="div"></div>
</div>

<script>
    document.getElementById('command').addEventListener('keypress', (event) => {
        console.log(event);
        if (event.key === 'Enter') {
            document.getElementById('sendCommand').click();
            return false
        }
    });
</script>
</body>
</html>
